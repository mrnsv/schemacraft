name: Run Pytest on Push and Pull

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag schemacraft:latest

      - name: Run Pytest in Container
        run: |
          docker run --rm schemacraft:latest pytest

      - name: Send Discord Notification
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
          -d '{ "content": "Your message content here." }' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}

      # - name: Notify Failure (if job fails)
      #   uses: actions/github-script@v6
      #   if: failure()
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       try:
      #         github.issues.createComment({
      #           issue_number: context.issue.number,
      #           owner: context.repo.owner,
      #           repo: context.repo.repo,
      #           body: 'Pytest tests failed in workflow! Please fix and push again before merging.'
      #         })
      #       except (TypeError):
      #         pass  # Silently handle the error
